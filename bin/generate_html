#!/usr/bin/env python

from dominate import *
from dominate.tags import *
import urllib
import os
import errno
import datetime
import codecs

def mkdir_p_idempotent(dir_name):
    try:
        os.makedirs(dir_name)
    except OSError as exc:
        if exc.errno == errno.EEXIST and os.path.isdir(dir_name):
            pass
        else:
            raise

def generate_milestone_page(title, data, output_dir):
    _html2 = document(title=title)
    with _html2:
        h1(title)
        for k in data.keys():
            with h2() as h:
                a(k, href="https://github.com/%s/issues?milestone=%d&state=open" % (k, data[k]["number"]))
            h += " %d/%d" % (data[k]["closed"], data[k]["open"]+data[k]["closed"])
            progress(max=data[k]["open"]+data[k]["closed"], value=data[k]["closed"])
            for i in data[k]["issues"]:
                li(a("#%d - %s" % (i["number"], i["title"]), href=i["url"]))

    with _html2:
        p("Last generated at %s" % (datetime.datetime.now()))

    with codecs.open(os.path.join(output_dir, title, "index.html"), "w", encoding="utf-8") as f:
        f.write(_html2.render())


def generate_sample_html(json_db, output_dir):
    _html = document(title="Riak Milestones")
    with _html.head:
        link(rel='stylesheet', href='style.css')
    for k in json_db.keys():
        mkdir_p_idempotent(os.path.join(output_dir, k))
        with _html:
            with h1() as h:
                a(k, href="%s" % urllib.quote(k))
            openissues = sum([json_db[k][x]["open"] for x in json_db[k].keys()])
            closedissues = sum([json_db[k][x]["closed"] for x in json_db[k].keys()])
            h += " %d/%d" % (closedissues, openissues+closedissues)
            progress(max=openissues+closedissues, value=closedissues)
        generate_milestone_page(k, json_db[k], output_dir)

    with _html:
        p("Last generated at %s" % (datetime.datetime.now()))

    with codecs.open(os.path.join(output_dir, "index.html"), "w", encoding="utf-8") as f:
        f.write(_html.render())

if __name__ == '__main__':
    import sys
    import json
    (json_input, output_dir) = sys.argv[1:3]
    json_db = json.load(open(json_input, 'r'))
    generate_sample_html(json_db, output_dir)
